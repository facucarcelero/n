<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parrilla Los Nogales - Panel de Administración</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .logo-font { font-family: 'Lora', serif; }
        .hidden { display: none; }
        .action-button i { pointer-events: none; }
        
        /* Modales siempre encima */
        .modal-base { z-index: 50; }
        .modal-top-layer { z-index: 60; }

        @media (max-width: 767px) {
            #admin-panel-container thead { display: none; }
            #admin-panel-container tbody,
            #admin-panel-container tr,
            #admin-panel-container td { display: block; width: 100%; }
            #admin-panel-container tr { margin-bottom: 1.5rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; background-color: #ffffff; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); overflow: hidden; }
            #admin-panel-container td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid #f3f4f6; }
            #admin-panel-container .actions-cell { justify-content: center; padding-top: 1rem; padding-bottom: 1rem; }
            #admin-panel-container .actions-cell::before { display: none; }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app">
        <div id="admin-view">
            <div class="container mx-auto p-4 sm:p-6 lg:p-8">
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Panel de Control</h1>
                        <p class="text-lg text-green-800 logo-font" style="font-weight:700;">Parrilla Los Nogales</p>
                    </div>
                    </div>
                <div id="admin-panel-container"></div>
            </div>
        </div>
    </div>
    
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden modal-base flex items-center justify-center p-4"></div>
    <div id="search-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden modal-base overflow-y-auto flex items-center justify-center p-4"></div>
    <div id="deleteConfirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden modal-top-layer flex items-center justify-center p-4"></div>
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden modal-top-layer overflow-y-auto flex items-center justify-center p-4"></div>

    <template id="reservation-form-template">
        <form id="reservationForm" class="space-y-6">
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Tus Datos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nombre y Apellido</label>
                        <input type="text" id="name" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                        <input type="tel" id="phone" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
                    </div>
                </div>
            </div>
            <div class="space-y-4 pt-4">
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Detalles de la Reserva</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="date" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
                    </div>
                    <div>
                        <label for="time" class="block text-sm font-medium text-gray-700 mb-1">Hora</label>
                        <input type="time" id="time" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
                    </div>
                    <div>
                        <label for="diners" class="block text-sm font-medium text-gray-700 mb-1">Comensales</label>
                        <input type="number" id="diners" min="1" value="2" required class="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
                    </div>
                </div>
            </div>
            <button type="submit" class="w-full bg-green-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-500 transition-transform transform hover:scale-105 flex items-center justify-center gap-2"><i class="ph ph-calendar-check text-xl"></i>Verificar y Reservar</button>
        </form>
    </template>

    <template id="admin-panel-template">
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                <label for="dateFilter" class="block text-sm font-medium text-gray-700">Seleccionar fecha base:</label>
                <div class="flex items-center">
                    <input type="date" id="dateFilter" class="w-full p-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
                    <button id="refresh-button" title="Refrescar" class="action-button ml-2 p-3 bg-green-100 text-green-700 rounded-full hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-green-500 transition-transform transform hover:rotate-90">
                        <i class="ph ph-arrow-clockwise text-lg"></i>
                    </button>
                </div>
                <button id="show-search-button" title="Buscar Reserva" class="p-2 bg-gray-100 text-gray-600 rounded-full shadow-sm hover:bg-gray-200 transition">
                    <i class="ph ph-magnifying-glass text-2xl"></i>
                </button>
            </div>
            
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                <label for="periodSelector" class="block text-sm font-medium text-gray-700">Mostrar balance por:</label>
                <select id="periodSelector" class="p-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
                    <option value="daily">Diario</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensual</option>
                    <option value="yearly">Anual</option>
                    <option value="custom">Rango Personalizado</option>
                </select>
            </div>

            <div id="customDateRangeInputs" class="flex flex-col sm:flex-row items-center gap-4 mb-6 hidden">
                <label for="dateRangeStart" class="block text-sm font-medium text-gray-700">Desde:</label>
                <input type="date" id="dateRangeStart" class="w-full p-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
                <label for="dateRangeEnd" class="block text-sm font-medium text-gray-700">Hasta:</label>
                <input type="date" id="dateRangeEnd" class="w-full p-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-600">
            </div>

            <div class="grid grid-cols-1 gap-4 mt-6 text-center">
                <div class="bg-gray-100 p-4 rounded-lg shadow-inner col-span-full">
                    <h3 class="font-bold text-gray-600">Total Comensales <span id="periodDisplay"></span></h3>
                    <p id="totalDinersPeriod" class="text-4xl font-extrabold text-gray-800">0</p>
                </div>
                
                <div id="turnTotalsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4 col-span-full"> 
                    <div class="bg-green-50 p-4 rounded-lg shadow-inner">
                        <h3 id="lunchTurnTitle" class="font-bold text-green-700">Total Almuerzos</h3>
                        <p id="totalDinersLunch" class="text-3xl font-extrabold text-green-800">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg shadow-inner">
                        <h3 id="dinnerTurnTitle" class="font-bold text-green-700">Total Cenas</h3>
                        <p id="totalDinersDinner" class="text-3xl font-extrabold text-green-800">0</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800" id="reservationsListTitle">Listado de Reservas <span id="reservationsListTitleDate" class="text-green-700"></span></h2>
                <p class="text-sm text-gray-500 mt-1" id="selectedPeriodRangeDisplay"></p>
            </div>
            <div class="overflow-x-auto">
                <table id="reservationsTable" class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-6 py-3">Nombre</th>
                            <th class="px-6 py-3">Teléfono</th>
                            <th class="px-6 py-3">Fecha</th>
                            <th class="px-6 py-3">Hora</th>
                            <th class="px-6 py-3 text-center">Comensales</th>
                            <th class="px-6 py-3">Turno</th>
                            <th class="px-6 py-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsTableBody"></tbody>
                </table>
            </div>
        </div>
    </template>
    <template id="delete-modal-template"><div class="relative w-full max-w-sm p-5 border shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i class="ph ph-warning-circle text-2xl text-red-600"></i></div><h3 class="text-lg font-medium text-gray-900 mt-2">Eliminar Reserva</h3><p class="text-sm text-gray-500 px-7 py-3">¿Estás seguro? Esta acción no se puede deshacer.</p><div class="items-center px-4 py-3"><button id="confirmDeleteButton" class="px-4 py-2 bg-red-600 text-white rounded-md w-full shadow-sm hover:bg-red-700">Confirmar</button><button id="cancelDeleteButton" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button></div></div></div></template>
    <template id="login-modal-template"><div class="relative w-full max-w-sm p-5 border shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-100"><i class="ph ph-lock-key text-2xl text-gray-600"></i></div><h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Acceso de Administrador</h3><form id="admin-login-form" class="mt-4 px-7 py-3 space-y-3"><label for="admin-password" class="sr-only">Contraseña</label><input type="password" id="admin-password" placeholder="Ingresa tu contraseña" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500"><button type="submit" class="w-full bg-green-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800">Entrar</button></form><p id="admin-login-error" class="text-red-500 text-sm text-center h-4 mt-1"></p><div class="items-center px-4 py-3"><button id="close-admin-modal-button" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button></div></div></div></template>
    <template id="search-modal-template"><div class="relative w-full max-w-lg p-5 border shadow-lg rounded-md bg-white"><div class="mt-3"><h3 class="text-lg text-center leading-6 font-medium text-gray-900">Buscar mi Reserva</h3><form id="search-form" class="mt-4 px-7 py-3 space-y-3"><label for="search-phone" class="block text-sm font-medium text-gray-700">Ingresa tu número de teléfono</label><div class="flex gap-2"><input type="tel" id="search-phone" placeholder="Ej: 2641234567" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500"><button type="submit" class="bg-green-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800">Buscar</button></div></form><div id="search-results-container" class="mt-4 px-1 md:px-7 space-y-3 max-h-60 overflow-y-auto"></div><div id="search-message" class="text-center p-4"></div><div class="items-center px-4 py-3 mt-4 border-t"><button id="close-search-modal-button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cerrar</button></div></div></div></template>
    <template id="edit-modal-template"><div class="relative w-full max-w-lg p-5 border shadow-lg rounded-md bg-white"><button id="close-edit-modal-button" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"><i class="ph ph-x text-2xl"></i></button><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-medium text-gray-900">Editar Reserva</h3><div id="edit-form-container" class="mt-4 px-7 py-3"></div><div id="edit-message-area" class="mt-4 px-7"></div></div></div></template>
    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp, } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, doc, deleteDoc, addDoc, getDocs, updateDoc, getDoc, documentId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBS_eGNLqUH8SshfrnBaUvRTcjJKy5tFiI",
            authDomain: "losnogales-reservas.firebaseapp.com",
            projectId: "losnogales-reservas",
            storageBucket: "losnogales-reservas.appspot.com",
            messagingSenderId: "707614707617",
            appId: "1:707614707617:web:57ef12cf519d99ff8585e0",
            measurementId: "G-MBGF0QWF7K"
        };
        
        const MAX_CAPACITY = 160;
        // La contraseña del admin ya no es necesaria en este archivo
        const WHATSAPP_NUMBER = "+5492644593336"; 

        let db, auth, currentUserId;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, user => { 
                if (user) {
                    currentUserId = user.uid;
                }
            });
            // Autenticación anónima para permitir el acceso al panel. 
            // ¡Importante: Ajusta tus reglas de seguridad de Firestore para esto!
            signInAnonymously(auth).catch(error => {
                console.error("Error signing in anonymously:", error);
            });
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            document.body.innerHTML = `<div style="padding: 2rem; text-align: center; font-family: sans-serif;"><h1>Error de Conexión</h1><p>No se pudo conectar a Firebase. Revisa la configuración en el código y las reglas de tu base de datos.</p><p style="color: red;">${error.message}</p></div>`;
        }

        const getEl = (id) => document.getElementById(id);
        const adminView = getEl('admin-view'); 
        const adminLoginModal = getEl('admin-login-modal');
        const deleteConfirmationModal = getEl('deleteConfirmationModal');
        const searchModal = getEl('search-modal');
        const editModal = getEl('edit-modal');
        let resIdToDelete = null;
        let sourceForDelete = ''; 

        // Helper function to display messages within modals
        function displayModalMessage(messageElement, message, type, extraContent = '') {
            let bgColor, textColor, iconHtml = '';
            if (type === 'success') {
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                iconHtml = '<i class="ph ph-x-circle text-xl align-middle mr-2"></i>';
            } else { // info
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-800';
            }
            messageElement.innerHTML = `<div class="p-3 rounded-lg ${bgColor} ${textColor} text-sm">${iconHtml}${message}${extraContent}</div>`;
        }

        // Helper function to sanitize phone numbers
        function sanitizePhone(phone) {
            return phone.replace(/[^0-9]/g, ''); // Removes all non-numeric characters
        }

        // Helper functions for date and time formatting
        function formatDateForDisplay(dateString) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            if (!dateString || isNaN(new Date(dateString + 'T00:00:00'))) {
                return 'Fecha inválida'; 
            }
            return new Date(dateString + 'T00:00:00').toLocaleDateString('es-AR', options);
        }

        function formatTimeForDisplay(timeString) {
            return timeString + ' hs';
        }

        function toggleModal(modal, show) { modal.classList.toggle('hidden', !show); }
        
        // No se necesitan los botones de admin ni el de vuelta aquí.

        // Determine if a given date and time fall within a valid reservation period
        function getTurn(date, time) {
            const reservationDateTime = new Date(`${date}T${time}:00`);
            const hours = reservationDateTime.getHours();
            const minutes = reservationDateTime.getMinutes();
            
            let serviceDay = new Date(`${date}T00:00:00`); 
            if (hours === 0 && minutes > 0 && minutes <= 59) { 
                serviceDay.setDate(serviceDay.getDate() - 1);
            }
            const dayOfWeek = serviceDay.getDay(); 

            if ((dayOfWeek === 0 || (dayOfWeek >= 4 && dayOfWeek <= 6))) {
                if (hours >= 12 && (hours < 16 || (hours === 16 && minutes === 0))) { 
                    return { isValid: true, turnName: 'Almuerzo', closeTime: '16:00' };
                }
            }

            if (dayOfWeek >= 1 && dayOfWeek <= 6) {
                if (hours >= 20 || (hours >= 0 && hours < 1)) { 
                    return { isValid: true, turnName: 'Cena', closeTime: '01:00' };
                }
            }
            
            return { isValid: false, turnName: null, closeTime: null };
        }
        
        function validateReservationTime(date, time, context = 'client', messageArea = null) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            const reservationDateTime = new Date(`${date}T${time}:00`);
            reservationDateTime.setSeconds(0,0);
            reservationDateTime.setMilliseconds(0);

            const now = new Date();
            now.setSeconds(0,0);
            now.setMilliseconds(0);

            const reservationDateOnly = new Date(`${date}T00:00:00`);
            if (reservationDateOnly < today) {
                const msg = 'No puedes reservar para una fecha pasada.';
                displayModalMessage(messageArea, msg, 'error'); 
                return false;
            }

            if (reservationDateOnly.getTime() === today.getTime()) {
                const requiredAdvanceTime = new Date(now.getTime() + (30 * 60 * 1000));
                requiredAdvanceTime.setSeconds(0,0);
                requiredAdvanceTime.setMilliseconds(0);
                
                if (reservationDateTime < requiredAdvanceTime) {
                    const msg = 'Fuera de Tiempo: Las reservas para hoy deben hacerse con al menos 30 minutos de anticipación.';
                    displayModalMessage(messageArea, msg, 'error');
                    return false;
                }
            }
            
            const turnData = getTurn(date, time);
            if (!turnData.isValid) {
                const msg = 'CERRADO: El restaurante no está abierto en el horario seleccionado.';
                displayModalMessage(messageArea, msg, 'error');
                return false;
            }

            if (turnData.closeTime) { 
                let closeDateTime;
                if (turnData.turnName === 'Cena' && turnData.closeTime === '01:00') {
                    const nextDayDate = new Date(`${date}T00:00:00`);
                    nextDayDate.setDate(nextDayDate.getDate() + 1);
                    closeDateTime = new Date(`${nextDayDate.toISOString().slice(0,10)}T${turnData.closeTime}:00`);
                } else {
                    closeDateTime = new Date(`${date}T${turnData.closeTime}:00`);
                }
                closeDateTime.setSeconds(0,0);
                closeDateTime.setMilliseconds(0);

                const cutoffTime = new Date(closeDateTime.getTime() - (60 * 60 * 1000));
                cutoffTime.setSeconds(0,0);
                cutoffTime.setMilliseconds(0);
                
                if (reservationDateTime >= cutoffTime) {
                    const msg = 'No se pueden hacer reservas con menos de 1 hora de anticipación al cierre del turno.';
                    displayModalMessage(messageArea, msg, 'error');
                    return false;
                }
            }
            
            return true;
        }

        async function handleSearchReservations(e) {
            e.preventDefault();
            const phone = sanitizePhone(getEl('search-phone').value);
            const resultsContainer = getEl('search-results-container');
            const messageEl = getEl('search-message');
            resultsContainer.innerHTML = '';
            messageEl.textContent = 'Buscando...';

            if (!phone) {
                messageEl.textContent = 'Por favor, ingresa un número de teléfono.';
                return;
            }

            const q = query(collection(db, "reservations"), where("phone", "==", phone));
            try {
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    messageEl.textContent = 'No se encontraron reservas con ese número de teléfono.';
                    return;
                }
                
                messageEl.textContent = '';
                snapshot.docs.forEach(doc => {
                    const res = { id: doc.id, ...doc.data() };
                    const dateFormatted = formatDateForDisplay(res.date);
                    const resultCard = document.createElement('div');
                    resultCard.className = "p-3 border rounded-lg bg-gray-50 flex justify-between items-center";
                    resultCard.setAttribute('data-id', res.id);
                    resultCard.innerHTML = `
                        <div>
                            <p class="font-bold">${res.name}</p>
                            <p class="text-sm text-gray-600">${dateFormatted} - ${res.time} hs - ${res.diners} personas</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${res.id}" class="action-button edit-res-btn p-2 text-blue-500 hover:text-blue-700 rounded-full hover:bg-blue-100"><i class="ph ph-pencil-simple text-lg"></i></button>
                            <button data-id="${res.id}" class="action-button delete-res-btn p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                    `;
                    resultsContainer.appendChild(resultCard);
                });
            } catch (error) {
                console.error("Error searching reservations:", error);
                messageEl.textContent = 'Ocurrió un error al buscar las reservas.';
            }
        }

        async function handleSearchResultActions(e) {
            const button = e.target.closest('.action-button');
            if (!button) return;

            const id = button.dataset.id;
            if (button.classList.contains('edit-res-btn')) {
                const docRef = doc(db, "reservations", id);
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        editModal.innerHTML = getEl('edit-modal-template').innerHTML;
                        const resData = docSnap.data();
                        const formContainer = getEl('edit-form-container');
                        const messageArea = getEl('edit-message-area');
                        formContainer.innerHTML = getEl('reservation-form-template').innerHTML;
                        
                        const form = formContainer.querySelector('form');
                        form.id = 'editReservationForm';
                        form.querySelector('button[type="submit"]').textContent = 'Guardar Cambios';
                        form.querySelector('button[type="submit"]').innerHTML = '<i class="ph ph-check-circle text-xl"></i>Guardar Cambios';


                        form.name.value = resData.name;
                        form.phone.value = resData.phone;
                        form.date.value = resData.date;
                        form.time.value = resData.time;
                        form.diners.value = resData.diners;
                        
                        getEl('close-edit-modal-button').addEventListener('click', () => toggleModal(editModal, false));
                        toggleModal(editModal, true);
                        
                        form.addEventListener('submit', async (submitEvent) => {
                            submitEvent.preventDefault();
                            messageArea.innerHTML = ''; 
                            
                            const newDate = form.date.value;
                            const newTime = form.time.value;
                            
                            if (!validateReservationTime(newDate, newTime, 'modal', messageArea)) {
                                return; 
                            }
                            
                            const newDiners = parseInt(form.diners.value, 10);
                            const turnData = getTurn(newDate, newTime);

                            const q = query(collection(db, "reservations"), where("date", "==", newDate), where("turn", "==", turnData.turnName), where(documentId(), "!=", id));
                            const snapshot = await getDocs(q);
                            const otherDiners = snapshot.docs.reduce((sum, doc) => sum + doc.data().diners, 0);
                            
                            const availableCapacity = MAX_CAPACITY - otherDiners;

                            if (newDiners > availableCapacity) {
                                const dateFormatted = formatDateForDisplay(newDate);
                                const inquiryMsg = encodeURIComponent(`Hola Parrilla Los Nogales, quisiera consultar para modificar mi reserva a ${newDiners} personas el día ${dateFormatted} a las ${newTime}hs, ya que no encontré lugar en la web. ¿Habrá alguna posibilidad?`);
                                const whatsappBtn = `<a href="https://wa.me/${WHATSAPP_NUMBER}?text=${inquiryMsg}" target="_blank" class="mt-2 inline-block w-full text-center bg-yellow-500 text-black font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 transition text-sm flex items-center justify-center gap-2"><i class="ph ph-whatsapp-logo text-lg"></i>Coordinar modificación</a>`;
                                displayModalMessage(messageArea, `Solo quedan <strong>${availableCapacity}</strong> lugares disponibles.`, 'error', whatsappBtn);
                                return;
                            }
                            
                            const updatedData = {
                                name: form.name.value, 
                                phone: sanitizePhone(form.phone.value),
                                date: newDate,
                                time: newTime, 
                                diners: newDiners,
                                turn: turnData.turnName
                            };

                            await updateDoc(docRef, updatedData);
                            toggleModal(editModal, false);
                            getEl('search-form').requestSubmit(); // Refresh search results
                        });
                    } else {
                        console.error("Reservation document not found for editing:", id);
                        displayModalMessage(getEl('search-message'), 'No se encontró la reserva para editar.', 'error');
                    }
                } catch (error) {
                    console.error("Error fetching reservation for edit:", error);
                    displayModalMessage(getEl('search-message'), 'Ocurrió un error al cargar la reserva para editar.', 'error');
                }
            } else if (button.classList.contains('delete-res-btn')) {
                resIdToDelete = id;
                sourceForDelete = 'search';
                openDeleteConfirmation();
            }
        }
        
        function openDeleteConfirmation() {
            deleteConfirmationModal.innerHTML = getEl('delete-modal-template').innerHTML;
            toggleModal(deleteConfirmationModal, true);
            getEl('confirmDeleteButton').addEventListener('click', handleDelete);
            getEl('cancelDeleteButton').addEventListener('click', () => toggleModal(deleteConfirmationModal, false));
        }

        async function handleDelete() {
            if (!resIdToDelete) return;
            const docRef = doc(db, "reservations", resIdToDelete);
            
            try {
                const docSnap = await getDoc(docRef);
                let reservationData = null;
                if (docSnap.exists()) {
                    reservationData = docSnap.data();
                }

                await deleteDoc(docRef);

                if (reservationData && sourceForDelete === 'search') {
                    const dateFormatted = formatDateForDisplay(reservationData.date);
                    const message = `AVISO DE CANCELACIÓN\n\nSe ha cancelado la siguiente reserva:\n\n*Cliente:* ${reservationData.name}\n*Fecha:* ${dateFormatted}\n*Hora:* ${reservationData.time} hs\n*Personas:* ${reservationData.diners}`;
                    const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                }

                if (sourceForDelete === 'admin') {
                    const dateFilterValue = getEl('dateFilter').value;
                    const periodSelectorValue = getEl('periodSelector').value;
                    const dateRangeStartValue = getEl('dateRangeStart').value;
                    const dateRangeEndValue = getEl('dateRangeEnd').value;
                    fetchAdminReservations(dateFilterValue, periodSelectorValue, dateRangeStartValue, dateRangeEndValue);
                } else if (sourceForDelete === 'search') {
                    const resultsContainer = getEl('search-results-container');
                    const cardToDelete = resultsContainer.querySelector(`[data-id="${resIdToDelete}"]`);
                    if (cardToDelete) {
                        cardToDelete.remove();
                    }
                    if (resultsContainer.children.length === 0) {
                        getEl('search-message').textContent = 'No se encontraron más reservas con ese número.';
                    }
                }
            } catch (error) {
                console.error("Error al eliminar la reserva:", error);
                alert("Hubo un error al intentar eliminar la reserva.");
            } finally {
                toggleModal(deleteConfirmationModal, false);
                resIdToDelete = null;
            }
        }

        function initializeAdminPanel() {
            const container = getEl('admin-panel-container');
            // Inicializar el panel si aún no lo está
            if (container.innerHTML === '') {
                 container.innerHTML = getEl('admin-panel-template').innerHTML;
            }
           
            // Después de que innerHTML se ha establecido, obtenemos las referencias a los elementos
            const dateFilter = getEl('dateFilter');
            const periodSelector = getEl('periodSelector');
            const customDateRangeInputs = getEl('customDateRangeInputs');
            const dateRangeStart = getEl('dateRangeStart');
            const dateRangeEnd = getEl('dateRangeEnd');
            
            // Establecer la fecha inicial y cargar los datos
            setInitialAdminDateAndFetch(); 
            
            // Asignar eventos de cambio
            dateFilter.onchange = () => fetchAdminReservations(dateFilter.value, periodSelector.value, dateRangeStart.value, dateRangeEnd.value);
            periodSelector.onchange = () => {
                customDateRangeInputs.classList.toggle('hidden', periodSelector.value !== 'custom');
                fetchAdminReservations(dateFilter.value, periodSelector.value, dateRangeStart.value, dateRangeEnd.value);
            };
            if(dateRangeStart) dateRangeStart.onchange = () => fetchAdminReservations(dateFilter.value, periodSelector.value, dateRangeStart.value, dateRangeEnd.value);
            if(dateRangeEnd) dateRangeEnd.onchange = () => fetchAdminReservations(dateFilter.value, periodSelector.value, dateRangeStart.value, dateRangeEnd.value);
            
            getEl('refresh-button').onclick = () => fetchAdminReservations(dateFilter.value, periodSelector.value, dateRangeStart.value, dateRangeEnd.value);

            // Event listener para botones de eliminar en la tabla
            getEl('reservationsTableBody').addEventListener('click', (e) => {
                const button = e.target.closest('.delete-res-btn');
                if (button) {
                    resIdToDelete = button.dataset.id;
                    sourceForDelete = 'admin';
                    openDeleteConfirmation();
                }
            });

            // ASIGNAMOS EL LISTENER PARA EL BOTÓN DE BÚSQUEDA AQUÍ, 
            // YA QUE EL BOTÓN YA ESTÁ EN LA PLANTILLA Y EL DOM SE HABRÁ CARGADO.
            const showSearchButton = getEl('show-search-button');
            if (showSearchButton) { 
                showSearchButton.addEventListener('click', () => {
                    searchModal.innerHTML = getEl('search-modal-template').innerHTML;
                    toggleModal(searchModal, true);
                    getEl('search-form').addEventListener('submit', handleSearchReservations);
                    getEl('close-search-modal-button').addEventListener('click', () => toggleModal(searchModal, false));
                    getEl('search-results-container').addEventListener('click', handleSearchResultActions);
                });
            }
        }
        
        // Establecer la fecha inicial y realizar la primera carga de datos para el panel de administración
        function setInitialAdminDateAndFetch() {
            const dateFilter = getEl('dateFilter');
            const periodSelector = getEl('periodSelector');
            const dateRangeStart = getEl('dateRangeStart');
            const dateRangeEnd = getEl('dateRangeEnd');

            if (!dateFilter.value) {
                const today = new Date();
                dateFilter.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            }
            
            const isCustomPeriod = periodSelector.value === 'custom';
            getEl('customDateRangeInputs').classList.toggle('hidden', !isCustomPeriod);

            if (isCustomPeriod) {
                if (dateRangeStart && !dateRangeStart.value) {
                    dateRangeStart.value = dateFilter.value;
                }
                if (dateRangeEnd && !dateRangeEnd.value) {
                    dateRangeEnd.value = dateFilter.value;
                }
            } else {
                if (dateRangeStart) dateRangeStart.value = ''; 
                if (dateRangeEnd) dateRangeEnd.value = '';
            }

            fetchAdminReservations(dateFilter.value, periodSelector.value, dateRangeStart ? dateRangeStart.value : '', dateRangeEnd ? dateRangeEnd.value : '');
        }

        async function fetchAdminReservations(baseDateString, period, customStart, customEnd) {
            if (!db) {
                console.error("Firestore DB not initialized.");
                return;
            }

            const reservationsCollection = collection(db, "reservations");
            let q;
            let startDate, endDate;
            let titleDateText = '';
            let periodRangeDisplayText = '';

            let validBaseDateString = baseDateString;
            const tempBaseDate = new Date(baseDateString + 'T00:00:00');
            if (isNaN(tempBaseDate.getTime())) {
                console.warn("Invalid baseDateString provided, falling back to today's date.");
                const today = new Date();
                validBaseDateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            }
            const baseDate = new Date(validBaseDateString + 'T00:00:00');


            switch (period) {
                case 'daily':
                    startDate = baseDate;
                    endDate = new Date(baseDate);
                    endDate.setDate(endDate.getDate() + 1); 
                    titleDateText = `del ${formatDateForDisplay(validBaseDateString)}`;
                    periodRangeDisplayText = '';
                    break;
                case 'weekly':
                    startDate = new Date(baseDate);
                    startDate.setDate(baseDate.getDate() - baseDate.getDay()); 
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 7); 
                    titleDateText = '';
                    periodRangeDisplayText = `del ${formatDateForDisplay(startDate.toISOString().slice(0,10))} al ${formatDateForDisplay(new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate() - 1).toISOString().slice(0,10))}`;
                    break;
                case 'monthly':
                    startDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
                    endDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + 1, 1);
                    titleDateText = '';
                    periodRangeDisplayText = `del mes de ${baseDate.toLocaleString('es-AR', { month: 'long', year: 'numeric' })}`;
                    break;
                case 'yearly':
                    startDate = new Date(baseDate.getFullYear(), 0, 1);
                    endDate = new Date(baseDate.getFullYear() + 1, 0, 1);
                    titleDateText = '';
                    periodRangeDisplayText = `del año ${baseDate.getFullYear()}`;
                    break;
                case 'custom':
                    let actualCustomStart = customStart;
                    let actualCustomEnd = customEnd;

                    if (!actualCustomStart || isNaN(new Date(actualCustomStart + 'T00:00:00'))) {
                        console.warn("Invalid customStart date provided, falling back to baseDateString.");
                        actualCustomStart = validBaseDateString;
                    }
                    if (!actualCustomEnd || isNaN(new Date(actualCustomEnd + 'T00:00:00'))) {
                        console.warn("Invalid customEnd date provided, falling back to baseDateString.");
                        actualCustomEnd = validBaseDateString;
                    }

                    startDate = new Date(actualCustomStart + 'T00:00:00');
                    endDate = new Date(actualCustomEnd + 'T00:00:00');
                    endDate.setDate(endDate.getDate() + 1); 
                    titleDateText = '';
                    periodRangeDisplayText = `Desde ${formatDateForDisplay(actualCustomStart)} hasta ${formatDateForDisplay(actualCustomEnd)}`;
                    break;
                default:
                    startDate = baseDate;
                    endDate = new Date(baseDate);
                    endDate.setDate(endDate.getDate() + 1);
                    titleDateText = `del ${formatDateForDisplay(validBaseDateString)}`;
                    periodRangeDisplayText = '';
            }

            getEl('reservationsListTitleDate').textContent = titleDateText;
            getEl('selectedPeriodRangeDisplay').textContent = periodRangeDisplayText;
            getEl('periodDisplay').textContent = periodRangeDisplayText ? `(${periodRangeDisplayText})` : `del ${formatDateForDisplay(validBaseDateString)}`;

            q = query(reservationsCollection, 
                where("date", ">=", startDate.toISOString().slice(0, 10)),
                where("date", "<", endDate.toISOString().slice(0, 10))
            );

            const reservationsTableBody = getEl('reservationsTableBody');
            reservationsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando reservas...</td></tr>';
            getEl('totalDinersPeriod').textContent = '0';
            getEl('totalDinersLunch').textContent = '0';
            getEl('totalDinersDinner').textContent = '0';

            try {
                const querySnapshot = await getDocs(q);
                let totalDiners = 0;
                let lunchDiners = 0;
                let dinnerDiners = 0;
                let reservations = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    reservations.push({ id: doc.id, ...data });
                    totalDiners += data.diners;
                    
                    const { turnName } = getTurn(data.date, data.time); 
                    
                    if (turnName === 'Almuerzo') {
                        lunchDiners += data.diners;
                    } else if (turnName === 'Cena') {
                        dinnerDiners += data.diners;
                    }
                });

                reservations.sort((a, b) => {
                    const dateA = new Date(`${a.date}T${a.time}`);
                    const dateB = new Date(`${b.date}T${b.time}`);
                    return dateA - dateB;
                });

                reservationsTableBody.innerHTML = ''; 

                if (reservations.length === 0) {
                    reservationsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No hay reservas para el período seleccionado.</td></tr>';
                } else {
                    reservations.forEach(res => {
                        const row = `
                            <tr>
                                <td data-label="Nombre" class="px-6 py-3 font-medium text-gray-900 whitespace-nowrap">${res.name}</td>
                                <td data-label="Teléfono" class="px-6 py-3">${res.phone}</td>
                                <td data-label="Fecha" class="px-6 py-3">${formatDateForDisplay(res.date)}</td>
                                <td data-label="Hora" class="px-6 py-3">${formatTimeForDisplay(res.time)}</td>
                                <td data-label="Comensales" class="px-6 py-3 text-center">${res.diners}</td>
                                <td data-label="Turno" class="px-6 py-3">${res.turn}</td>
                                <td data-label="Acciones" class="px-6 py-3 text-center actions-cell">
                                    <button data-id="${res.id}" class="action-button delete-res-btn p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100" title="Eliminar reserva"><i class="ph ph-trash text-lg"></i></button>
                                </td>
                            </tr>
                        `;
                        reservationsTableBody.innerHTML += row;
                    });
                }
                
                getEl('totalDinersPeriod').textContent = totalDiners;
                
                const lunchTurnTitleEl = getEl('lunchTurnTitle'); 
                const dinnerTurnTitleEl = getEl('dinnerTurnTitle'); 
                const turnTotalsContainerEl = getEl('turnTotalsContainer'); 

                if (lunchTurnTitleEl && dinnerTurnTitleEl && turnTotalsContainerEl) {
                    getEl('totalDinersLunch').textContent = lunchDiners;
                    getEl('totalDinersDinner').textContent = dinnerDiners;

                    if (period === 'daily') {
                        lunchTurnTitleEl.textContent = 'Almuerzo';
                        dinnerTurnTitleEl.textContent = 'Cena';
                    } else {
                        lunchTurnTitleEl.textContent = 'Total Almuerzos';
                        dinnerTurnTitleEl.textContent = 'Total Cenas';
                    }
                } else {
                    console.warn("Elementos de título de totales de turno no encontrados. Se omite la actualización de textContent.");
                }
            } catch (error) {
                console.error("Error fetching admin reservations:", error);
                reservationsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error al cargar las reservas.</td></tr>';
            }
        }

        // Inicializar el panel de administración al cargar la página
        document.addEventListener('DOMContentLoaded', initializeAdminPanel);
    </script>
</body>
</html>
